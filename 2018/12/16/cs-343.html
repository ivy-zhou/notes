<!DOCTYPE html><html lang="en">
  <head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>CS 343 - Sentences</title>

<meta name="description" content="Professor Peter Buhr, Winter 2018These notes are incomplete and only cover pre-midterm content.1. Advanced Control Flow      Use breaks and while to avoid fl...">
<link rel="canonical" href="notes/2018/12/16/cs-343.html"><link rel="alternate" type="application/rss+xml" title="Sentences" href="notes/feed.xml"><!-- start favicons snippet, use https://realfavicongenerator.net/ --><link rel="apple-touch-icon" sizes="180x180" href="notes/assets/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="notes/assets/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="notes/assets/favicon-16x16.png"><link rel="manifest" href="notes/assets/site.webmanifest"><link rel="mask-icon" href="notes/assets/safari-pinned-tab.svg" color="#fc4d50"><link rel="shortcut icon" href="notes/assets/favicon.ico">

<meta name="msapplication-TileColor" content="#ffc40d"><meta name="msapplication-config" content="notes/assets/browserconfig.xml">

<meta name="theme-color" content="#ffffff">
<!-- end favicons snippet --><link rel="stylesheet" href="notes/assets/css/main.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" ><!-- start custom head snippets -->

<!-- end custom head snippets -->
<script>(function() {
  window.isArray = function(val) {
    return Object.prototype.toString.call(val) === '[object Array]';
  };
  window.isString = function(val) {
    return typeof val === 'string';
  };

  window.hasEvent = function(event) {
    return 'on'.concat(event) in window.document;
  };

  window.isOverallScroller = function(node) {
    return node === document.documentElement || node === document.body || node === window;
  };

  window.isFormElement = function(node) {
    var tagName = node.tagName;
    return tagName === 'INPUT' || tagName === 'SELECT' || tagName === 'TEXTAREA';
  };

  window.pageLoad = (function () {
    var loaded = false, cbs = [];
    window.addEventListener('load', function () {
      var i;
      loaded = true;
      if (cbs.length > 0) {
        for (i = 0; i < cbs.length; i++) {
          cbs[i]();
        }
      }
    });
    return {
      then: function(cb) {
        cb && (loaded ? cb() : (cbs.push(cb)));
      }
    };
  })();
})();
(function() {
  window.throttle = function(func, wait) {
    var args, result, thisArg, timeoutId, lastCalled = 0;

    function trailingCall() {
      lastCalled = new Date;
      timeoutId = null;
      result = func.apply(thisArg, args);
    }
    return function() {
      var now = new Date,
        remaining = wait - (now - lastCalled);

      args = arguments;
      thisArg = this;

      if (remaining <= 0) {
        clearTimeout(timeoutId);
        timeoutId = null;
        lastCalled = now;
        result = func.apply(thisArg, args);
      } else if (!timeoutId) {
        timeoutId = setTimeout(trailingCall, remaining);
      }
      return result;
    };
  };
})();
(function() {
  var Set = (function() {
    var add = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (data[i] === item) {
          return;
        }
      }
      this.size ++;
      data.push(item);
      return data;
    };

    var Set = function(data) {
      this.size = 0;
      this._data = [];
      var i;
      if (data.length > 0) {
        for (i = 0; i < data.length; i++) {
          add.call(this, data[i]);
        }
      }
    };
    Set.prototype.add = add;
    Set.prototype.get = function(index) { return this._data[index]; };
    Set.prototype.has = function(item) {
      var i, data = this._data;
      for (i = 0; i < data.length; i++) {
        if (this.get(i) === item) {
          return true;
        }
      }
      return false;
    };
    Set.prototype.is = function(map) {
      if (map._data.length !== this._data.length) { return false; }
      var i, j, flag, tData = this._data, mData = map._data;
      for (i = 0; i < tData.length; i++) {
        for (flag = false, j = 0; j < mData.length; j++) {
          if (tData[i] === mData[j]) {
            flag = true;
            break;
          }
        }
        if (!flag) { return false; }
      }
      return true;
    };
    Set.prototype.values = function() {
      return this._data;
    };
    return Set;
  })();

  window.Lazyload = (function(doc) {
    var queue = {js: [], css: []}, sources = {js: {}, css: {}}, context = this;
    var createNode = function(name, attrs) {
      var node = doc.createElement(name), attr;
      for (attr in attrs) {
        if (attrs.hasOwnProperty(attr)) {
          node.setAttribute(attr, attrs[attr]);
        }
      }
      return node;
    };
    var end = function(type, url) {
      var s, q, qi, cbs, i, j, cur, val, flag;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        s[url] = true;
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (cur.urls.has(url)) {
            qi = cur, val = qi.urls.values();
            qi && (cbs = qi.callbacks);
            for (flag = true, j = 0; j < val.length; j++) {
              cur = val[j];
              if (!s[cur]) {
                flag = false;
              }
            }
            if (flag && cbs && cbs.length > 0) {
              for (j = 0; j < cbs.length; j++) {
                cbs[j].call(context);
              }
              qi.load = true;
            }
          }
        }
      }
    };
    var load = function(type, urls, callback) {
      var s, q, qi, node, i, cur,
        _urls = typeof urls === 'string' ? new Set([urls]) : new Set(urls), val, url;
      if (type === 'js' || type ==='css') {
        s = sources[type], q = queue[type];
        for (i = 0; i < q.length; i++) {
          cur = q[i];
          if (_urls.is(cur.urls)) {
            qi = cur;
            break;
          }
        }
        val = _urls.values();
        if (qi) {
          callback && (qi.load || qi.callbacks.push(callback));
          callback && (qi.load && callback());
        } else {
          q.push({
            urls: _urls,
            callbacks: callback ? [callback] : [],
            load: false
          });
          for (i = 0; i < val.length; i++) {
            node = null, url = val[i];
            if (s[url] === undefined) {
              (type === 'js' ) && (node = createNode('script', { src: url }));
              (type === 'css') && (node = createNode('link', { rel: 'stylesheet', href: url }));
              if (node) {
                node.onload = (function(type, url) {
                  return function() {
                    end(type, url);
                  };
                })(type, url);
                (doc.head || doc.body).appendChild(node);
                s[url] = false;
              }
            }
          }
        }
      }
    };
    return {
      js: function(url, callback) {
        load('js', url, callback);
      },
      css: function(url, callback) {
        load('css', url, callback);
      }
    };
  })(this.document);
})();
</script><script>
  (function() {
    var TEXT_VARIABLES = {
      version: '2.2.6',
      sources: {
        font_awesome: 'https://use.fontawesome.com/releases/v5.0.13/css/all.css',
        jquery: 'https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js',
        leancloud_js_sdk: '//cdn.jsdelivr.net/npm/leancloud-storage@3.13.2/dist/av-min.js',
        chart: 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js',
        gitalk: {
          js: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.js',
          css: 'https://cdn.bootcss.com/gitalk/1.2.2/gitalk.min.css'
        },
        valine: 'https://unpkg.com/valine/dist/Valine.min.js',
        mathjax: 'https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML',
        mermaid: 'https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js'
      },
      site: {
        toc: {
          selectors: 'h1,h2,h3'
        }
      },
      paths: {
        search_js: 'notes/assets/search.js'
      }
    };
    window.TEXT_VARIABLES = TEXT_VARIABLES;
  })();
</script>
</head>
  <body>
    <div class="root" data-is-touch="false">
      <div class="layout--page js-page-root"><div class="page__main js-page-main page__viewport has-aside cell cell--auto">

      <div class="page__main-inner"><div class="page__header d-print-none"><header class="header"><div class="main">
      <div class="header__title">
        <div class="header__brand"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="24px" height="24px" viewBox="0 0 24 24">
<style type="text/css">
	.st0{fill:#515151;}
</style>
<path class="st0" d="M1.7,22.3c5.7-5.7,11.3-5.7,17,0c3.3-3.3,3.5-5.3,0.8-6c2.7,0.7,3.5-1.1,2.3-5.6s-3.3-5.2-6.3-2.1
	c3-3,2.3-5.2-2.1-6.3S7,1.8,7.7,4.6C7,1.8,5,2.1,1.7,5.3C7.3,11,7.3,16.7,1.7,22.3"/>
</svg>
<a title="A loosely organized collection of notes and thoughts
" href="notes/">Sentences</a></div><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></div><nav class="navigation">
        <ul><li class="navigation__item"><a href="notes/archive.html">Archive</a></li><li class="navigation__item"><a href="notes/about.html">About</a></li><li><button class="button button--secondary button--circle search-button js-search-toggle"><i class="fas fa-search"></i></button></li></ul>
      </nav></div>
  </header>
</div><div class="page__content"><div class ="main"><div class="grid grid--reverse">

              <div class="col-aside d-print-none js-col-aside"><aside class="page__aside js-page-aside"><div class="toc-aside js-toc-root"></div>
</aside></div>

              <div class="col-main cell cell--auto"><!-- start custom main top snippet -->

<!-- end custom main top snippet -->
<article itemscope itemtype="http://schema.org/Article"><div class="article__header"><header><h1>CS 343</h1></header><span class="split-space">&nbsp;</span>
          <a class="edit-on-github"
            title="Edit on Github"
            href="https://github.com/ivy-zhou/notes/tree/master/_posts/2018-12-16-cs-343/2018-12-16-cs-343.md">
            <i class="far fa-edit"></i></a></div><meta itemprop="headline" content="CS 343"><div class="article__info clearfix"><ul class="left-col menu"><li>
              <a class="button button--secondary button--pill button--sm"
                href="notes/archive.html?tag=uwaterloo">uwaterloo</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="notes/archive.html?tag=notes">notes</a>
            </li><li>
              <a class="button button--secondary button--pill button--sm"
                href="notes/archive.html?tag=incomplete">incomplete</a>
            </li></ul><ul class="right-col menu"><li><i class="far fa-calendar-alt"></i> <span>Dec 16, 2018</span>
            </li></ul></div><meta itemprop="author" content="Ivy Zhou"/><meta itemprop="datePublished" content="2018-12-16T00:00:00+00:00">
    <meta itemprop="keywords" content="uwaterloo,notes,incomplete"><div class="js-article-content"><div class="layout--article"><!-- start custom article top snippet -->

<!-- end custom article top snippet -->
<div class="article__content" itemprop="articleBody"><blockquote>
  <p>Professor Peter Buhr, Winter 2018</p>
</blockquote>

<p class="warning">These notes are incomplete and only cover pre-midterm content.</p>

<h2 id="1-advanced-control-flow">1. Advanced Control Flow</h2>

<ul>
  <li>
    <p>Use breaks and while to avoid flag variables, flag variables are basically gotos since they can be set/reset/tested at arbitrary points in a program</p>
  </li>
  <li>
    <p>Don’t do things like</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (;;) {
    s1
    if(c1) {
        s2 // s2 is loop body, no relation to c1
    } else {
        break; // should just break on !c1
    }
}
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="11-static-multi-level-exits">1.1 Static multi-level exits</h4>

<ul>
  <li>static multilevel exit: exit multiple control structures where exit points are known at compile time</li>
  <li>should label all exits if syntax allows i.e. <code class="language-plaintext highlighter-rouge">L1: if(...) {... break L1 ...}</code></li>
  <li>
    <p>breaks are gotos with 2 limitiations:</p>

    <ul>
      <li>cannot loop</li>
      <li>cannot branch into a control structure</li>
    </ul>
  </li>
  <li>only use gotos as breaks and continues</li>
</ul>

<h4 id="12-dynamic-memory-allocation">1.2 Dynamic Memory Allocation</h4>

<ul>
  <li>use the stack, you don’t need to manage storage and it’s more efficient than heap</li>
  <li>you need to use the heap only when
    <ul>
      <li>variable’s storage must outlive the block it’s allocated in</li>
      <li>when the amount of data that needs to be stored is unkown</li>
      <li>when an array of objects must be initialized via the object’s constructor</li>
      <li>when large local variables are allocated on a small stack (since having a large stack that fits the variable would waste space and dynamic stack growth is complicated)</li>
    </ul>
  </li>
</ul>

<h2 id="2-dynamic-multi-level-exit">2. Dynamic Multi-level Exit</h2>

<ul>
  <li>
    <p>modularization: contiguous code block that can be factored into a helper method</p>
  </li>
  <li>
    <p>Sometimes we can’t modularize code blocks with multi-levle exits into routines because they use labels that have scope outside of the routine</p>
  </li>
  <li>
    <p>dynamic multi-level exit: allows nonlocal transfers (jump to any statement, rather than the statement right after the call as with normal return transfer, or to some statement NOT after the call as in exceptional return transfer)</p>

    <p>In the example below, we use a label <code class="language-plaintext highlighter-rouge">L</code> in order the skip over g when <code class="language-plaintext highlighter-rouge">goto L</code> is called in f to return to <code class="language-plaintext highlighter-rouge">L = L2</code> set in h. This automatically causes g to terminate as well as f.</p>

    <p><img src="/Users/ivyzhou/Library/Application Support/typora-user-images/image-20181216101021199.png" alt="image-20181216101021199" /></p>
  </li>
  <li>
    <p>label variable in nonlocal transfer contains:</p>

    <ul>
      <li>pointer to a block activation on the stack (used in recursion)</li>
      <li>transfer point with in the block (set as the line <code class="language-plaintext highlighter-rouge">L = L2</code>)</li>
    </ul>
  </li>
  <li>nonlocal transfer is possible in C using:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">jmp_buf</code> to declare a label</li>
      <li><code class="language-plaintext highlighter-rouge">set_buf</code> to set a label</li>
      <li><code class="language-plaintext highlighter-rouge">longjump</code> to goto a label variable</li>
    </ul>
  </li>
  <li>nonlocal transfer is too general, like goto</li>
</ul>

<h4 id="21-traditional-approaches">2.1 Traditional approaches</h4>

<ul>
  <li>return code: return value indiciating normal or exceptional execution e.g. printf()</li>
  <li>status flag: set shared global variable indicating normal or exceptional execution e.g. errno in UNIX</li>
  <li>fix-up routine: global and/or local routine passed in to use in case of exception</li>
  <li>return union: mimics normal return type but actually has a return code inside of it sometimes instead of a result e.g. return an optional that the caller can check with holds_alternative</li>
  <li>drawbacks of traditional approaches
    <ul>
      <li>Checking return code or status flag is optional</li>
      <li>Return code mixes exceptional and normal values, makes type larger than it should be</li>
      <li>Testing return code or status flag is often done inline, makes code difficult to read and sometimes you can’t handle an error yourself at all (e.g. if you’re a library)</li>
      <li>Status flag can be overwritten before being examine, can’t use it in concurrent environments</li>
      <li>local fix-up routine increases the number of parameters, thus increasing the cost of each call and requiring passing through multiple levels even if only one routine needs it</li>
      <li>global fix-up routines can’t be used in concurrent environments</li>
      <li>return codes are flags, they’re ugly to use rather than dynamic multi-level exits</li>
    </ul>
  </li>
</ul>

<h4 id="22-exception-handling">2.2 Exception Handling</h4>

<ul>
  <li>exceptional event: error event known to exist but isn’t relevant to the algorithm, i.e. they’re not errors with the algorithm</li>
  <li>exception handling mechanism (EHM): handle exception using control flow</li>
</ul>

<h4 id="23-execution-environment">2.3 Execution Environment</h4>

<ul>
  <li>EHM has to handle <code class="language-plaintext highlighter-rouge">finally</code> clauses, which always execute regardless of exception</li>
  <li>EHM has to handle object destructors, which always execute regardless of exception</li>
  <li>If there are multiple stacks, EHM has to find the correct handler on one of the stacks</li>
  <li>EHM has to handle errors thrown by different coroutines</li>
</ul>

<h4 id="24-terminology">2.4 Terminology</h4>

<ul>
  <li>execution: where an exception can be raised i.e. any entity with a runtime stack</li>
  <li>exception type: kind of exception</li>
  <li>exception: instance of an exception type</li>
  <li>raise: throw, creates an exception</li>
  <li>source execution: execution creating exception</li>
  <li>faulting execution: execution handling exception</li>
  <li>local exception: exception where source and faulting are the same</li>
  <li>nonlocal exception: exception where source and faulting are not the same (delivery of error to faulting necessary)</li>
  <li>concurrent exception: nonlocal exception where source and faulting are executing concurrently</li>
  <li>propagation: directs control from a raise in the source to a handler in the faulting</li>
  <li>propagation mechanism: rules used to locate a handler:
    <ul>
      <li>predence to handlers higher in the call stack</li>
    </ul>
  </li>
  <li>handler: inline routine responsible for handling raised exception, matches one or more exception types, can return/reraise/raise new</li>
  <li>guarded block: block of code with associated handlers e.g. try catch</li>
  <li>
    <p>ungarded block: block of code with no handlers</p>
  </li>
  <li>termination: control cannot return to the raise point</li>
  <li>stack unwinding: all blocks on faulting stack from the raise block to the handling block are terminated</li>
  <li>resumption: control returns to the raise point i.e. no stack unwinding</li>
</ul>

<h4 id="25-staticdynamic-callreturn">2.5 Static/Dynamic Call/Return</h4>

<ul>
  <li>static call: compile time lookup of routine/exception name</li>
  <li>dynamic call: runtime lookup of routine/exception name</li>
  <li>static return: after a routine/hander completes, it returns to its static definition</li>
  <li>dynamic return: after a routine/handler completes, it returns to its dynamic call context</li>
  <li>4 possible combinations:
    <ul>
      <li>static call, static return: sequel</li>
      <li>static call, dynamic return: routine</li>
      <li>dynamic call, static return: termination exception (i.e. exception raised without resumption)</li>
      <li>dynamic call, dynamic return: routine pointer, virtual routine, resumption</li>
    </ul>
  </li>
</ul>

<h4 id="26-static-propagation-sequel">2.6 Static Propagation (Sequel)</h4>

<ul>
  <li>sequel: routine with no return value where control returns to the <strong>end</strong> of the block in which the sequel was declared, equivalent to breaking to a label, static call + static return</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// label A:</span>
<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">sequel</span> <span class="n">S1</span><span class="p">(...)</span> <span class="p">{...}</span>
    <span class="kt">void</span> <span class="n">M1</span><span class="p">(...)</span> <span class="p">{</span> <span class="c1">// modularization of if(...) break A;</span>
    	<span class="p">...</span>
        <span class="k">if</span><span class="p">(...)</span> <span class="n">S1</span><span class="p">(...);</span> <span class="c1">// like writing if(...) break A;</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="c1">// label B</span>
    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
    	<span class="n">sequel</span> <span class="n">S2</span><span class="p">(...)</span> <span class="p">{...}</span>
        <span class="nl">C:</span> <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
            <span class="n">M1</span><span class="p">(...);</span>
            <span class="k">if</span><span class="p">(...)</span> <span class="n">S2</span><span class="p">(...);</span> <span class="c1">// like writing break B</span>
            <span class="k">if</span><span class="p">(...)</span> <span class="k">break</span> <span class="n">C</span><span class="p">;</span>
        <span class="p">}</span> <span class="c1">// break C comes out here</span>
    <span class="p">}</span> <span class="c1">// end of block in which S2 is defined, therefore S2(...) comes out here</span>
<span class="p">}</span> <span class="c1">// end of block in which S1 is defined, therefore M1() comes out here</span>
</code></pre></div></div>

<ul>
  <li>sequel makes it possible to modularize code with static exits</li>
  <li>sequel causes stack unwinding, since loops have scope and can declare variables</li>
  <li>advantages of sequel:
    <ul>
      <li>returning to sequel is efficient since handler is statically known</li>
    </ul>
  </li>
  <li>disadvantages of sequel:
    <ul>
      <li>cannot be used in library code since sequel defined in user code is not visible inside library code</li>
    </ul>
  </li>
</ul>

<h4 id="27-dynamic-propagation">2.7 Dynamic Propagation</h4>

<ul>
  <li>dynamic propagation is another name for dynamic call + static return (termination exception)</li>
  <li>advantages of dynamic propagation:
    <ul>
      <li>works for separately compiler programs</li>
    </ul>
  </li>
  <li>disadvantages of dynamic propagation:
    <ul>
      <li>have to lookup handler at runtime</li>
    </ul>
  </li>
</ul>

<h5 id="271-termination">2.7.1 Termination</h5>

<ul>
  <li>
    <p>3 termination forms after non-recoverable exception:</p>

    <ul>
      <li>
        <p>nonlocal transfer: goto handler</p>
      </li>
      <li>
        <p>terminate: limited transfer</p>

        <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">E</span> <span class="p">{}</span> <span class="c1">// label</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(...)</span> <span class="p">{</span>
    <span class="p">...</span> <span class="k">throw</span> <span class="n">E</span><span class="p">();</span> <span class="p">...</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span> <span class="c1">// declare sequel</span>
        <span class="n">f</span><span class="p">(...);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="p">{...}</span>
    <span class="c1">// Finding this catch(E) handler is dynamic call</span>
    <span class="c1">// Return from this handler goes to after try, like a sequel, so it's a static return</span>
<span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>
        <p>retry: terminate everything, then restart the guarded block which caught the exception (can simulate with a while true around a try catch)</p>
      </li>
    </ul>
  </li>
</ul>

<h5 id="272-resumption">2.7.2 Resumption</h5>

<ul>
  <li>resumption: dynamic call (call to handler) + dynamic return (return to line right after raise), so the handler acts like a fix-up</li>
</ul>

<h4 id="212-inherited-members">2.12 Inherited Members</h4>

<ul>
  <li>Exception is a type, exceptions are objects (construct them before you throw them!)</li>
  <li>Exceptions in C++ do object slicing (i.e. if passed a child class as a parent class, you can only throw the child as the parent), but uC++ doesn’t</li>
</ul>

<h4 id="213-handler">2.13 Handler</h4>

<ul>
  <li>In uC++, order your _CatchResume clauses before your catch clauses</li>
  <li>If you have a <code class="language-plaintext highlighter-rouge">catch(...)</code> or a <code class="language-plaintext highlighter-rouge">_CatchResume(...)</code> put it at the end of your <code class="language-plaintext highlighter-rouge">catch</code> or your <code class="language-plaintext highlighter-rouge">_CatchResume</code> clauses respectively</li>
  <li>Resumption handlers can access variables in their local scope because they have a lexical link to the block they were declared in</li>
  <li>Resumption handlers can’t break/continue (static return)</li>
  <li>When a resume exception propagates without a handler, the defaultResume handler is invoked, which does a throw on the exception instead</li>
</ul>

<h2 id="3-coroutine">3. Coroutine</h2>

<ul>
  <li>
    <p>coroutine: routine that can be suspended at some point and resumed from that point</p>
  </li>
  <li>coroutine state:
    <ul>
      <li>execution location: current point of execution of a coroutine</li>
      <li>execution state: coroutine stack, allows for calls to routines defined inside coroutine and variables</li>
      <li>execution status: active or inactive or terminated</li>
    </ul>
  </li>
  <li>coroutines handle problems that need to retain state between calls e.g. finite state machine, device driver receiving input stream</li>
  <li>semi-coroutine: implcitly reactivate coroutine that activated it via suspend</li>
  <li>full-coroutine: coroutine A explicitly activating coroutine B through a member of B, which then activates coroutine A again at some point (cycle)</li>
</ul>

<h4 id="31-semi-coroutine">3.1 Semi-coroutine</h4>

<ul>
  <li>
    <p>coroutines are classes that replace internal state with execution flow and allow multiple coroutines to run at a time</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_Coroutine</span> <span class="n">Fibonacci</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fn</span><span class="p">;</span> <span class="c1">// communication variable</span>
    <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">fn1</span><span class="p">,</span> <span class="n">fn2</span><span class="p">;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fn1</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
        <span class="n">suspend</span><span class="p">();</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">fn2</span> <span class="o">=</span> <span class="n">fn</span> <span class="p">;</span> <span class="n">fn1</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
        <span class="n">suspend</span><span class="p">();</span>
        <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn1</span> <span class="o">+</span> <span class="n">fn2</span><span class="p">;</span>
            <span class="n">fn2</span> <span class="o">=</span> <span class="n">fn1</span><span class="p">;</span>
            <span class="n">fn1</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
            <span class="n">suspend</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nl">public:</span>
    <span class="kt">int</span> <span class="n">next</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">resume</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">fn</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>coroutine becomes an object on first resume, coroutine becomes an object when main ends</p>
  </li>
  <li>
    <p>coroutine main is usually private or protected so that others only interact with the coroutine through its interface members, so suspend/resume() must be protected as well</p>
  </li>
  <li>
    <p>when deleted, a coroutine’s stack is always unwound and any destructors are executed to prevent memory leaks</p>
  </li>
  <li>
    <p>we can put a resume() in the coroutine’s constructor to initialize it</p>
  </li>
  <li>
    <p>coroutine stack does not grow, so you may have to adjust the stack size through the constructor or call <code class="language-plaintext highlighter-rouge">verify()</code> to check for stack overflow</p>
  </li>
  <li>
    <p>EX: Iterator to return every element of a binary tree in order</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="k">class</span> <span class="nc">Btree</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="nc">Node</span> <span class="p">{...};</span>
    <span class="nl">public:</span>
    <span class="n">_Coroutine</span> <span class="n">Iterator</span> <span class="p">{</span>
        <span class="n">Node</span> <span class="o">*</span><span class="n">cursor</span><span class="p">;</span>
        <span class="kt">void</span> <span class="n">walk</span><span class="p">(</span><span class="n">Node</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="c1">// If the node is a leaf, return it</span>
            <span class="k">if</span><span class="p">(</span><span class="n">node</span> <span class="o">-&gt;</span> <span class="n">left</span> <span class="o">==</span> <span class="n">nullptry</span> <span class="o">&amp;&amp;</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">right</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">cursor</span> <span class="o">=</span> <span class="n">node</span><span class="p">;</span>
                <span class="n">suspend</span><span class="p">()</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// recurse using coroutine stack!</span>
                <span class="n">walk</span><span class="p">(</span><span class="n">node</span> <span class="o">-&gt;</span> <span class="n">left</span><span class="p">);</span>
                <span class="n">walk</span><span class="p">(</span><span class="n">node</span> <span class="o">-&gt;</span> <span class="n">right</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">walk</span><span class="p">(</span><span class="n">cursor</span><span class="p">);</span>
     		<span class="n">cursor</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span> <span class="c1">// last action is a suspend that resumes the coroutine's starter()</span>
        <span class="nl">public:</span>
        <span class="n">Iterator</span><span class="p">(</span><span class="n">Btree</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">btree</span><span class="p">)</span> <span class="o">:</span> <span class="n">cursor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btree</span><span class="p">.</span><span class="n">root</span><span class="p">)</span> <span class="p">{}</span>
        <span class="n">T</span> <span class="o">*</span><span class="n">next</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">resume</span><span class="p">();</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>EX: Device driver that parses messages between STX and ETX pairs and then checks a final 2 byte CRC. If there’s an ESC before an ETX, don’t count it as an ETX.</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_Coroutine</span> <span class="n">DeviceDriver</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="p">{</span> <span class="n">STX</span> <span class="o">=</span> <span class="sc">'\002'</span><span class="p">,</span> <span class="n">ESC</span> <span class="o">=</span> <span class="sc">'\033'</span><span class="p">,</span> <span class="n">ETX</span> <span class="o">=</span> <span class="sc">'\003'</span> <span class="p">}</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
    <span class="nl">public:</span>
    <span class="n">DeviceDriver</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span> <span class="o">:</span> <span class="n">msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span> <span class="n">resume</span><span class="p">();</span> <span class="p">}</span>
    <span class="kt">void</span> <span class="n">next</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">byte</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
        <span class="n">resume</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nl">private:</span>
    <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// usable for multiple messages</span>
        <span class="nl">msg:</span> <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">checkval</span><span class="p">;</span>
            <span class="c1">// find STX</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="n">suspend</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">byte</span> <span class="o">!=</span> <span class="n">STX</span><span class="p">);</span>
            <span class="nl">eom:</span> <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
                <span class="n">suspend</span><span class="p">();</span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="n">STX</span><span class="p">:</span>
                        <span class="p">...</span> <span class="c1">// protocol error</span>
                        <span class="k">continue</span> <span class="n">msg</span><span class="p">;</span> <span class="c1">// start looking for new STX</span>
                    <span class="k">case</span> <span class="n">ETX</span><span class="p">:</span>
                   		<span class="k">break</span> <span class="n">eom</span><span class="p">;</span>
                    <span class="k">case</span> <span class="n">ESC</span><span class="p">:</span>
                        <span class="n">suspend</span><span class="p">();</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span> <span class="c1">// end switch</span>
                <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
                    <span class="p">...</span> <span class="c1">// buffer full, length error</span>
                    <span class="k">continue</span> <span class="n">msg</span><span class="p">;</span> <span class="c1">// start looking for new STX</span>
                <span class="p">}</span> <span class="c1">// end if</span>
                <span class="n">msg</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
                <span class="n">length</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span> <span class="c1">// end eom for</span>
            <span class="n">suspend</span><span class="p">();</span>
            <span class="n">checkval</span> <span class="o">=</span> <span class="n">byte</span><span class="p">;</span>
            <span class="n">suspend</span><span class="p">();</span>
            <span class="n">checkval</span> <span class="o">=</span> <span class="p">(</span><span class="n">checkval</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">byte</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">crc</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">checkval</span><span class="p">))</span> <span class="p">{</span>
                <span class="p">...</span> <span class="c1">// handle CRC error</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="c1">// end msg for</span>
    <span class="p">}</span> <span class="c1">// end main</span>
<span class="p">}</span> <span class="c1">// end DeviceDriver</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>EX: Producer consumer (modified with exceptions, a concept from 3.2 and also it’s a full coroutine)</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_Event</span> <span class="n">Stop</span> <span class="p">{};</span> <span class="c1">// replaces bool done flag in Consumer</span>
<span class="n">_Coroutine</span> <span class="n">Cons</span> <span class="p">{</span>
    <span class="n">Prod</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Count up total amount of money consumer has paid</span>
        <span class="kt">int</span> <span class="n">money</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">receipt</span><span class="p">;</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"cons "</span> <span class="o">&lt;&lt;</span> <span class="n">p1</span> <span class="o">&lt;&lt;</span> <span class="s">" "</span> <span class="o">&lt;&lt;</span> <span class="n">p2</span><span class="p">;</span>
            <span class="n">status</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// pass arbitrary message between producer and consumer</span>
            <span class="n">receipt</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">payment</span><span class="p">(</span><span class="n">money</span><span class="p">);</span> <span class="c1">// suspend to get next items</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">" paid $"</span> <span class="o">&lt;&lt;</span> <span class="n">money</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">money</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="c1">// Ensure that previous transaction is finished before we end</span>
            <span class="n">_Enable</span> <span class="p">{}</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">Stop</span><span class="p">)</span> <span class="p">{}</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"cons stops"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nl">public:</span>
    <span class="n">Cons</span><span class="p">(</span><span class="n">Prod</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">)</span> <span class="o">:</span> <span class="n">p</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kt">int</span> <span class="n">delivery</span><span class="p">(</span><span class="kt">int</span> <span class="n">p1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span> <span class="o">-&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span> <span class="k">this</span> <span class="o">-&gt;</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span><span class="p">;</span>
        <span class="n">resume</span><span class="p">();</span> <span class="c1">// activate Consumer main</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">_Coroutine</span> <span class="n">Prod</span> <span class="p">{</span>
    <span class="n">Cons</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">;</span>
    <span class="c1">// Count up total amount of money producer has received</span>
    <span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">money</span><span class="p">,</span> <span class="n">receipt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Produce N times</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Produce p1, p2</span>
            <span class="kt">int</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">rand</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
            <span class="n">cout</span> <span class="s">"prod "</span> <span class="o">&lt;&lt;</span> <span class="n">p1</span> <span class="o">&lt;&lt;</span> <span class="s">" "</span> <span class="o">&lt;&lt;</span> <span class="n">p2</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="c1">// Resume Consumer so it can receive p1 and p2</span>
            <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">delivery</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"prod received $"</span> <span class="o">&lt;&lt;</span> <span class="n">money</span> <span class="o">&lt;&lt;</span> <span class="s">" stat "</span> <span class="o">&lt;&lt;</span> <span class="n">status</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">receipt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">_Resume</span> <span class="n">Stop</span><span class="p">()</span> <span class="n">at</span> <span class="n">resumer</span><span class="p">();</span>
        <span class="n">suspend</span><span class="p">();</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"prod stops"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nl">public:</span>
    <span class="n">Prod</span><span class="p">(</span><span class="n">Cons</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="n">c</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kt">int</span> <span class="n">payment</span><span class="p">(</span><span class="kt">int</span> <span class="n">money</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span> <span class="o">-&gt;</span> <span class="n">money</span> <span class="o">=</span> <span class="n">money</span><span class="p">;</span>
        <span class="n">resume</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">receipt</span><span class="p">;</span> <span class="c1">// The first thing a consumer does when it wakes up is pick up its receipt</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">start</span><span class="p">(</span><span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">Con</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span> <span class="o">-&gt;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
        <span class="k">this</span> <span class="o">-&gt;</span> <span class="n">N</span> <span class="o">=</span> <span class="n">N</span><span class="p">;</span>
        <span class="n">resume</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="32-nonlocal-exceptions">3.2 Nonlocal Exceptions</h4>

<ul>
  <li>nonlocal exceptions are raised using <code class="language-plaintext highlighter-rouge">_Resume ... _At ...</code></li>
  <li>To catch nonlocal excpetions, you need an <code class="language-plaintext highlighter-rouge">_Enable {} </code> block for all exceptions or a<code class="language-plaintext highlighter-rouge">_Enable &lt;E1&gt;&lt;E2&gt; {}</code> block for E1, E2 only</li>
  <li><code class="language-plaintext highlighter-rouge">_Disable {}</code> blocks are allowed within enable blocks and vice versa</li>
  <li>Once you’ve raised an exception at a coroutine, you should suspend back to it or call a member on it which does a <code class="language-plaintext highlighter-rouge">resume()</code></li>
  <li>Multiple nonlocal exceptions are queued and delivered in FIFO order</li>
  <li>When a coroutine doesn’t handle an exception, it terminates and then throws an <code class="language-plaintext highlighter-rouge">UnhandledException</code> at its last resumer. <code class="language-plaintext highlighter-rouge">UnhandledException</code> is always enabled</li>
</ul>

<h4 id="33-full-coroutines">3.3 Full Coroutines</h4>

<ul>
  <li>
    <p>Each circle below is a method call</p>

    <p><img src="image-20181216143005132-4988605.png" alt="image-20181216143005132" /></p>
  </li>
  <li>
    <p>resume(): make the currently executing coroutine inactive and make whatever the <code class="language-plaintext highlighter-rouge">this</code> variable refers to active</p>
  </li>
  <li>
    <p>suspend(): make the currently executing coroutine inactive and make whatever the lastResumer is active</p>
  </li>
  <li>
    <p>Exception: last resumer is not changed when you’re resuming to yourself because that’s not useful</p>
  </li>
  <li>
    <p>3 phases to full coroutine program</p>

    <ol>
      <li>Starting the cycle (pairing everybody up requires a special case to close the cycle due to mutually recursive references)</li>
      <li>Executing the cylce</li>
      <li>Stopping the cycle (returning to main)</li>
    </ol>
  </li>
  <li>
    <p>EX: Pingpong</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_Coroutine</span> <span class="n">PingPong</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">N</span><span class="p">;</span>
    <span class="n">PingPong</span> <span class="o">*</span><span class="n">partner</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
            <span class="n">partner</span> <span class="o">-&gt;</span> <span class="n">cycle</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nl">public:</span>
    <span class="n">PingPong</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">N</span><span class="p">,</span> <span class="n">PingPong</span> <span class="o">&amp;</span><span class="n">partner</span><span class="p">)</span>
    	<span class="o">:</span> <span class="n">name</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">N</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">partner</span><span class="p">(</span><span class="o">&amp;</span><span class="n">partner</span><span class="p">)</span> <span class="p">{}</span>
    <span class="n">PingPong</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">N</span><span class="p">)</span> <span class="o">:</span> <span class="n">name</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">N</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">cycle</span><span class="p">()</span> <span class="p">{</span> <span class="n">resume</span><span class="p">();</span> <span class="p">};</span>
    <span class="kt">void</span> <span class="n">partner</span><span class="p">(</span><span class="n">PingPong</span> <span class="o">&amp;</span><span class="n">partner</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span> <span class="o">-&gt;</span> <span class="n">partner</span> <span class="o">=</span> <span class="n">partner</span><span class="p">;</span>
        <span class="n">resume</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="p">{</span> <span class="n">N</span> <span class="o">=</span> <span class="mi">20</span> <span class="p">};</span>
    <span class="n">PingPong</span> <span class="n">ping</span><span class="p">(</span><span class="s">"ping"</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">pong</span><span class="p">(</span><span class="s">"pong"</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">ping</span><span class="p">);</span>
    <span class="c1">// Ping will end first because it started first and resume to main</span>
    <span class="n">ping</span><span class="p">.</span><span class="n">partner</span><span class="p">(</span><span class="n">pong</span><span class="p">);</span>
    <span class="c1">// Main ends with ping terminated and pong unterminated</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>A semi-coroutine never calls resume() in somebody else’s method</p>
  </li>
</ul>

<h4 id="34-coroutine-languages">3.4 Coroutine Languages</h4>

<ul>
  <li>Coroutine implementations can be stackless (can’t call other routines) or stackful</li>
  <li><code class="language-plaintext highlighter-rouge">yield v</code> means I suspend and return you <code class="language-plaintext highlighter-rouge">v</code></li>
  <li><code class="language-plaintext highlighter-rouge">(yield)</code> means I suspend and you need to pass me a new value using <code class="language-plaintext highlighter-rouge">send(v)</code></li>
  <li>You can do generators/iterators in a stackless coroutine with yield</li>
  <li>
    <p>Simula, CLU, C#, Ruby, Python, JavaScript, Lua, F#, Boost all support yield</p>
  </li>
  <li>Python has stackless semi-coroutines which are routines instead of instances of a class (but you refer to an “instance” of a routine with dot notation in python)</li>
  <li>C++ Boost Library has stackful, semi/full coroutines</li>
</ul>

<h2 id="exceptions">Exceptions</h2>

<h4 id="44-exception-list">4.4 Exception List</h4>

<ul>
  <li>exception list: the list of exceptions that a routine might through
    <ul>
      <li>allows for static detection of no handler for exception (Java) or runtime detection where the exception can be converted into a special failure exception (C++)</li>
    </ul>
  </li>
  <li>Determining exception lists is hard because:
    <ul>
      <li>if you have a routine for some template class T, you’d have to list all exceptions possible for all classes T</li>
      <li>if you’re passed some routine pointer, you have to list all exceptions possible for all routines</li>
      <li>if your parent says that this method doesn’t throw exceptions, you can’t override the method and say it throws exceptions</li>
      <li>concurrent programs can throw any exceptions at any time</li>
    </ul>
  </li>
</ul>

<h4 id="45-destructor">4.5 Destructor</h4>

<ul>
  <li>You can’t raise exceptions in a destructor if there’s already exception propagation happening (check this with <code class="language-plaintext highlighter-rouge">uncaught_exception()</code>)
    <ul>
      <li>Suppose you raise an exception on x, which causes x to unwind and it’s destructor to be called. If x’s destructor raises an exception, then you can’t start the second exception without finding a handler to deal with the first exception because the second exception might remove the handlers for the first</li>
    </ul>
  </li>
</ul>

<h4 id="46-implementation">4.6 Implementation</h4>

<ul>
  <li>
    <p>Approach 1:</p>

    <ul>
      <li>associate a label variable with each exception type</li>
      <li>set label variable on entry to each guarded block with handler for the type</li>
      <li>reset label variable on exit to previous value</li>
    </ul>

    <p>For termination, you can’t just call the handler because you have to go through and destruct everybody first. But for resumption, you can do it.</p>
  </li>
  <li>
    <p>Approach 1 is expensive because setting/resetting label variables is expensive</p>
  </li>
  <li>
    <p>Approach 2:</p>

    <ul>
      <li>Store catch/destructor data externally for each block and then do a linear search for a handler along the stack</li>
    </ul>
  </li>
  <li>
    <p>Approach 2 has 0 cost on entering try-catch but is expensive on raise</p>
  </li>
</ul>

<h2 id="concurrency">Concurrency</h2>

<ul>
  <li>thread: path of execution</li>
  <li>process: thread + state information e.g. stack</li>
  <li>task: lightweight process i.e. shares memory with other tasks, therefore can pass pointer between tasks</li>
  <li>thread &lt; task &lt; process</li>
  <li>parallel execution: 2 or more operations occur simultaneously, only possible with 1 or more CPUs</li>
  <li>concurrent execution: 2 or more operations appear to be performed in parallel, therefore possible with 1 CPU</li>
</ul>

<h4 id="53-concurrent-hardware">5.3 Concurrent hardware</h4>

<ul>
  <li>Tasks can context switch at non-deterministic program locations due to preemptive scheduling</li>
</ul>

<h4 id="55-threading-model">5.5 Threading Model</h4>

<ul>
  <li>threading model: maps threads to CPUs by mapping threads to kernel threads (virtual processors) that are scheduled across the CPUs</li>
  <li>a process can own multiple kernel threads to provide parallelism within the process</li>
  <li>a program may schedule user threads on the kernel thread</li>
  <li>user:kernal:CPU mappings:
    <ul>
      <li>kernal threading (1:1:C): 1 user thread maps to 1 kernel thread</li>
      <li>generalized kernel threading (M:M:C): create M threads, each of which map 1:1 between user and kernel</li>
      <li>user threading (N:1:C): N user threads map to 1 kernel thread (no parallelism)</li>
      <li>user threading (N:M:C) N user threads map to M kernel threads</li>
    </ul>
  </li>
  <li>You can add nano threads on top of user threads and virtual machine above OS</li>
</ul>

<h4 id="56-concurrent-systems">5.6 Concurrent Systems</h4>

<ul>
  <li>concurrent system types:
    <ul>
      <li>discover concurrency in otherwise sequential program</li>
      <li>provide concurrency through implicit constructs</li>
      <li>provide concurreny through explicit constructs</li>
    </ul>
  </li>
</ul>

<h4 id="57-speedup">5.7 Speedup</h4>

<ul>
  <li>program speedup $S_C = T_1 / T_C$ where $C$ is the number of CPUs, $T_1$ is the number of newly concurrent instructions, $T_C$ is the time it taks $C$ CPUs to execute 1 instruction</li>
  <li>Aspects affecting speedup
    <ul>
      <li>amount of concurrency</li>
      <li>critical (slowest) path among concurrency (due to dependencies between threads)</li>
      <li>scheduler efficiency (starvation possible)</li>
    </ul>
  </li>
  <li>Amdahl’s Law: maximum speedup $S_C = \frac{1}{(1 - P) + P/C}$, where P is the concurrent section of the program, and we’re using C CPUs</li>
</ul>

<h4 id="58-concurrency">5.8 Concurrency</h4>

<ul>
  <li>
    <p>implicit concurrency:</p>

    <p>COBEGIN</p>
  </li>
  <li>
    <p>explicit concurrency:</p>

    <p>START/WAIT</p>
  </li>
</ul>

<h4 id="520-hardware-solutions">5.20 Hardware Solutions</h4>

<ul>
  <li>if we have an atomic read and write, we solve a lot of critical section problems</li>
</ul>
</div><section class="article__sharing d-print-none"></section><div class="d-print-none"><footer class="article__footer"><meta itemprop="dateModified" content="2018-12-16T00:00:00+00:00"><!-- start custom article footer snippet -->

<!-- end custom article footer snippet -->
<div class="article__subscribe"><div class="subscribe"><i class="fas fa-rss"></i> <a type="application/rss+xml" href="notes/feed.xml">Subscribe</a></div>
</div><div class="article__license"><div class="license">
    <p>This work is licensed under a <a itemprop="license" rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">Attribution-NonCommercial 4.0 International</a> license.
      <a rel="license" href="https://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Attribution-NonCommercial 4.0 International" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" />
      </a>
    </p>
  </div></div></footer>
<div class="article__section-navigator clearfix"><div class="previous"><span>PREVIOUS</span><a href="notes/2018/11/19/se-464-architecture-assignment.html">SE 464 Architecture Assignment - LLVM</a></div><div class="next"><span>NEXT</span><a href="notes/2018/12/18/cs-348.html">CS 348</a></div></div></div>

</div>

<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    $(function() {
      var $this ,$scroll;
      var $articleContent = $('.js-article-content');
      var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
      var scroll = hasSidebar ? '.js-page-main' : 'html, body';
      $scroll = $(scroll);

      $articleContent.find('.highlight').each(function() {
        $this = $(this);
        $this.attr('data-lang', $this.find('code').attr('data-lang'));
      });
      $articleContent.find('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]').each(function() {
        $this = $(this);
        $this.append($('<a class="anchor d-print-none" aria-hidden="true"></a>').html('<i class="fas fa-anchor"></i>'));
      });
      $articleContent.on('click', '.anchor', function() {
        $scroll.scrollToAnchor('#' + $(this).parent().attr('id'), 400);
      });
    });
  });
})();
</script>
</div><section class="page__comments d-print-none"></section></article><!-- start custom main bottom snippet -->

<!-- end custom main bottom snippet -->
</div>
            </div></div></div><div class="page__footer d-print-none">
<footer class="footer py-4 js-page-footer">
  <div class="main"><div itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ivy Zhou"><meta itemprop="url" content="notes/"><meta itemprop="description" content="an uneasy soul"><div class="footer__author-links"><div class="author-links">
  <ul class="menu menu--nowrap menu--inline"><li title="Follow me on Medium.">
        <a class="button button--circle medium-button" itemprop="sameAs" href="https://medium.com/ivyzhou" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M834.7 279.8l61.3-58.9V208H683.7L532.4 586.4 360.3 208H137.7v12.9l71.6 86.6c7 6.4 10.6 15.8 9.7 25.2V673c2.2 12.3-1.7 24.8-10.3 33.7L128 805v12.7h228.6v-12.9l-80.6-98a39.99 39.99 0 0 1-11.1-33.7V378.7l200.7 439.2h23.3l172.6-439.2v349.9c0 9.2 0 11.1-6 17.2l-62.1 60.3V819h301.2v-12.9l-59.9-58.9c-5.2-4-7.9-10.7-6.8-17.2V297a18.1 18.1 0 0 1 6.8-17.2z"></path>
</svg>
</div>
        </a>
      </li><li title="Follow me on Linkedin.">
        <a class="button button--circle linkedin-button" itemprop="sameAs" href="https://www.linkedin.com/in/zhouivy" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path d="M260.096 155.648c0 27.307008-9.899008 50.516992-29.696 69.632-19.796992 19.115008-45.396992 28.672-76.8 28.672-30.036992 0-54.612992-9.556992-73.728-28.672-19.115008-19.115008-28.672-42.324992-28.672-69.632 0-28.672 9.556992-52.224 28.672-70.656 19.115008-18.432 44.372992-27.648 75.776-27.648 31.403008 0 56.32 9.216 74.752 27.648 18.432 18.432 28.331008 41.984 29.696 70.656 0 0 0 0 0 0m-202.752 808.96c0 0 0-632.832 0-632.832 0 0 196.608 0 196.608 0 0 0 0 632.832 0 632.832 0 0-196.608 0-196.608 0 0 0 0 0 0 0m313.344-430.08c0-58.708992-1.364992-126.292992-4.096-202.752 0 0 169.984 0 169.984 0 0 0 10.24 88.064 10.24 88.064 0 0 4.096 0 4.096 0 40.96-68.267008 105.812992-102.4 194.56-102.4 68.267008 0 123.220992 22.868992 164.864 68.608 41.643008 45.739008 62.464 113.664 62.464 203.776 0 0 0 374.784 0 374.784 0 0-196.608 0-196.608 0 0 0 0-350.208 0-350.208 0-91.476992-33.451008-137.216-100.352-137.216-47.787008 0-81.236992 24.576-100.352 73.728-4.096 8.192-6.144 24.576-6.144 49.152 0 0 0 364.544 0 364.544 0 0-198.656 0-198.656 0 0 0 0-430.08 0-430.08 0 0 0 0 0 0" />
</svg>
</div>
        </a>
      </li><li title="Follow me on Github.">
        <a class="button button--circle github-button" itemprop="sameAs" href="https://github.com/ivy-zhou" target="_blank">
          <div class="icon"><svg fill="#000000" width="24px" height="24px" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
  <path class="svgpath" data-index="path_0" fill="#272636" d="M0 525.2c0 223.6 143.3 413.7 343 483.5 26.9 6.8 22.8-12.4 22.8-25.4l0-88.7c-155.3 18.2-161.5-84.6-172-101.7-21.1-36-70.8-45.2-56-62.3 35.4-18.2 71.4 4.6 113.1 66.3 30.2 44.7 89.1 37.2 119 29.7 6.5-26.9 20.5-50.9 39.7-69.6C248.8 728.2 181.7 630 181.7 513.2c0-56.6 18.7-108.7 55.3-150.7-23.3-69.3 2.2-128.5 5.6-137.3 66.5-6 135.5 47.6 140.9 51.8 37.8-10.2 80.9-15.6 129.1-15.6 48.5 0 91.8 5.6 129.8 15.9 12.9-9.8 77-55.8 138.8-50.2 3.3 8.8 28.2 66.7 6.3 135 37.1 42.1 56 94.6 56 151.4 0 117-67.5 215.3-228.8 243.7 26.9 26.6 43.6 63.4 43.6 104.2l0 128.8c0.9 10.3 0 20.5 17.2 20.5C878.1 942.4 1024 750.9 1024 525.3c0-282.9-229.3-512-512-512C229.1 13.2 0 242.3 0 525.2L0 525.2z" />
</svg>
</div>
        </a>
      </li></ul>
</div>
</div>
    </div><div class="site-info mt-2">
      <div>© Sentences 2020,
        Powered by <a title="Jekyll is a simple, blog-aware, static site generator." href="http://jekyllrb.com/">Jekyll</a> & <a
        title="TeXt is a super customizable Jekyll theme." href="https://github.com/kitian616/jekyll-TeXt-theme">TeXt Theme</a>.
      </div>
    </div>
  </div>
</footer>
</div></div>
    </div><script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $body = $('body'), $window = $(window);
    var $pageRoot = $('.js-page-root'), $pageMain = $('.js-page-main');
    var activeCount = 0;
    function modal(options) {
      var $root = this, visible, onChange, hideWhenWindowScroll = false;
      var scrollTop;
      function setOptions(options) {
        var _options = options || {};
        visible = _options.initialVisible === undefined ? false : show;
        onChange = _options.onChange;
        hideWhenWindowScroll = _options.hideWhenWindowScroll;
      }
      function init() {
        setState(visible);
      }
      function setState(isShow) {
        if (isShow === visible) {
          return;
        }
        visible = isShow;
        if (visible) {
          activeCount++;
          scrollTop = $(window).scrollTop() || $pageMain.scrollTop();
          $root.addClass('modal--show');
          $pageMain.scrollTop(scrollTop);
          activeCount === 1 && ($pageRoot.addClass('show-modal'), $body.addClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.on('scroll', hide);
          $window.on('keyup', handleKeyup);
        } else {
          activeCount > 0 && activeCount--;
          $root.removeClass('modal--show');
          $window.scrollTop(scrollTop);
          activeCount === 0 && ($pageRoot.removeClass('show-modal'), $body.removeClass('of-hidden'));
          hideWhenWindowScroll && window.hasEvent('touchstart') && $window.off('scroll', hide);
          $window.off('keyup', handleKeyup);
        }
        onChange && onChange(visible);
      }
      function show() {
        setState(true);
      }
      function hide() {
        setState(false);
      }
      function handleKeyup(e) {
        // Char Code: 27  ESC
        if (e.which ===  27) {
          hide();
        }
      }
      setOptions(options);
      init();
      return {
        show: show,
        hide: hide,
        $el: $root
      };
    }
    $.fn.modal = modal;
  });
})();
</script><div class="modal modal--overflow page__search-modal d-print-none js-page-search-modal"><script>
(function () {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    // search panel
    var search = (window.search || (window.search = {}));
    var useDefaultSearchBox = window.useDefaultSearchBox === undefined ?
      true : window.useDefaultSearchBox ;

    var $searchModal = $('.js-page-search-modal');
    var $searchToggle = $('.js-search-toggle');
    var searchModal = $searchModal.modal({ onChange: handleModalChange, hideWhenWindowScroll: true });
    var modalVisible = false;
    search.searchModal = searchModal;

    var $searchBox = null;
    var $searchInput = null;
    var $searchClear = null;

    function getModalVisible() {
      return modalVisible;
    }
    search.getModalVisible = getModalVisible;

    function handleModalChange(visible) {
      modalVisible = visible;
      if (visible) {
        search.onShow && search.onShow();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].focus();
      } else {
        search.onShow && search.onHide();
        useDefaultSearchBox && $searchInput[0] && $searchInput[0].blur();
        setTimeout(function() {
          useDefaultSearchBox && ($searchInput.val(''), $searchBox.removeClass('not-empty'));
          search.clear && search.clear();
          window.pageAsideAffix && window.pageAsideAffix.refresh();
        }, 400);
      }
    }

    $searchToggle.on('click', function() {
      modalVisible ? searchModal.hide() : searchModal.show();
    });
    // Char Code: 83  S, 191 /
    $(window).on('keyup', function(e) {
      if (!modalVisible && !window.isFormElement(e.target || e.srcElement) && (e.which === 83 || e.which === 191)) {
        modalVisible || searchModal.show();
      }
    });

    if (useDefaultSearchBox) {
      $searchBox = $('.js-search-box');
      $searchInput = $searchBox.children('input');
      $searchClear = $searchBox.children('.js-icon-clear');
      search.getSearchInput = function() {
        return $searchInput.get(0);
      };
      search.getVal = function() {
        return $searchInput.val();
      };
      search.setVal = function(val) {
        $searchInput.val(val);
      };

      $searchInput.on('focus', function() {
        $(this).addClass('focus');
      });
      $searchInput.on('blur', function() {
        $(this).removeClass('focus');
      });
      $searchInput.on('input', window.throttle(function() {
        var val = $(this).val();
        if (val === '' || typeof val !== 'string') {
          search.clear && search.clear();
        } else {
          $searchBox.addClass('not-empty');
          search.onInputNotEmpty && search.onInputNotEmpty(val);
        }
      }, 400));
      $searchClear.on('click', function() {
        $searchInput.val(''); $searchBox.removeClass('not-empty');
        search.clear && search.clear();
      });
    }
  });
})();
</script><div class="search search--dark">
  <div class="main">
    <div class="search__header">Search</div>
    <div class="search-bar">
      <div class="search-box js-search-box">
        <div class="search-box__icon-search"><i class="fas fa-search"></i></div>
        <input type="text" />
        <div class="search-box__icon-clear js-icon-clear">
          <a><i class="fas fa-times"></i></a>
        </div>
      </div>
      <button class="button button--theme-dark button--pill search__cancel js-search-toggle">
        Cancel</button>
    </div>
    <div class="search-result js-search-result"></div>
  </div>
</div>
<script>var SOURCES = window.TEXT_VARIABLES.sources;
var PAHTS = window.TEXT_VARIABLES.paths;
window.Lazyload.js([SOURCES.jquery, PAHTS.search_js], function() {
  var search = (window.search || (window.search = {}));
  var searchData = window.TEXT_SEARCH_DATA || {};

  function memorize(f) {
    var cache = {};
    return function () {
      var key = Array.prototype.join.call(arguments, ',');
      if (key in cache) return cache[key];
      else return cache[key] = f.apply(this, arguments);
    };
  }

  /// search
  function searchByQuery(query) {
    var i, j, key, keys, cur, _title, result = {};
    keys = Object.keys(searchData);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      for (j = 0; j < searchData[key].length; j++) {
        cur = searchData[key][j], _title = cur.title;
        if ((result[key] === undefined || result[key] && result[key].length < 4 )
          && _title.toLowerCase().indexOf(query.toLowerCase()) >= 0) {
          if (result[key] === undefined) {
            result[key] = [];
          }
          result[key].push(cur);
        }
      }
    }
    return result;
  }

  var renderHeader = memorize(function(header) {
    return $('<p class="search-result__header">' + header + '</p>');
  });

  var renderItem = function(index, title, url) {
    return $('<li class="search-result__item" data-index="' + index + '"><a class="button" href="' + url + '">' + title + '</a></li>');
  };

  function render(data) {
    if (!data) { return null; }
    var $root = $('<ul></ul>'), i, j, key, keys, cur, itemIndex = 0;
    keys = Object.keys(data);
    for (i = 0; i < keys.length; i++) {
      key = keys[i];
      $root.append(renderHeader(key));
      for (j = 0; j < data[key].length; j++) {
        cur = data[key][j];
        $root.append(renderItem(itemIndex++, cur.title, cur.url));
      }
    }
    return $root;
  }

  // search box
  var $result = $('.js-search-result'), $resultItems;
  var lastActiveIndex, activeIndex;

  function clear() {
    $result.html(null);
    $resultItems = $('.search-result__item'); activeIndex = 0;
  }
  function onInputNotEmpty(val) {
    $result.html(render(searchByQuery(val)));
    $resultItems = $('.search-result__item'); activeIndex = 0;
    $resultItems.eq(0).addClass('active');
  }

  search.clear = clear;
  search.onInputNotEmpty = onInputNotEmpty;

  function updateResultItems() {
    lastActiveIndex >= 0 && $resultItems.eq(lastActiveIndex).removeClass('active');
    activeIndex >= 0 && $resultItems.eq(activeIndex).addClass('active');
  }

  function moveActiveIndex(direction) {
    var itemsCount = $resultItems ? $resultItems.length : 0;
    if (itemsCount > 1) {
      lastActiveIndex = activeIndex;
      if (direction === 'up') {
        activeIndex = (activeIndex - 1 + itemsCount) % itemsCount;
      } else if (direction === 'down') {
        activeIndex = (activeIndex + 1 + itemsCount) % itemsCount;
      }
      updateResultItems();
    }
  }

  // Char Code: 13  Enter, 37  ⬅, 38  ⬆, 39  ➡, 40  ⬇
  $(window).on('keyup', function(e) {
    var modalVisible = search.getModalVisible && search.getModalVisible();
    if (modalVisible) {
      if (e.which === 38) {
        modalVisible && moveActiveIndex('up');
      } else if (e.which === 40) {
        modalVisible && moveActiveIndex('down');
      } else if (e.which === 13) {
        modalVisible && $resultItems && activeIndex >= 0 && $resultItems.eq(activeIndex).children('a')[0].click();
      }
    }
  });

  $result.on('mouseover', '.search-result__item > a', function() {
    var itemIndex = $(this).parent().data('index');
    itemIndex >= 0 && (lastActiveIndex = activeIndex, activeIndex = itemIndex, updateResultItems());
  });
});
</script>
</div></div>


<script>(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function scrollToAnchor(anchor, duration, callback) {
      var $root = this;
      $root.animate({ scrollTop: $(anchor).position().top }, duration, function() {
        window.history.replaceState(null, '', window.location.href.split('#')[0] + anchor);
        callback && callback();
      });
    }
    $.fn.scrollToAnchor = scrollToAnchor;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function affix(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroll,
        offsetBottom = 0, scrollTarget = window, scroll = window.document, disabled = false, isOverallScroller = true,
        rootTop, rootLeft, rootHeight, scrollBottom, rootBottomTop,
        hasInit = false, curState;

      function setOptions(options) {
        var _options = options || {};
        _options.offsetBottom && (offsetBottom = _options.offsetBottom);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroll && (scroll = _options.scroll);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $scrollTarget = $(scrollTarget);
        isOverallScroller = window.isOverallScroller($scrollTarget[0]);
        $scroll = $(scroll);
      }
      function preCalc() {
        top();
        rootHeight = $root.outerHeight();
        rootTop = $root.offset().top + (isOverallScroller ? 0 :  $scrollTarget.scrollTop());
        rootLeft = $root.offset().left;
      }
      function calc(needPreCalc) {
        needPreCalc && preCalc();
        scrollBottom = $scroll.outerHeight() - offsetBottom - rootHeight;
        rootBottomTop = scrollBottom - rootTop;
      }
      function top() {
        if (curState !== 'top') {
          $root.removeClass('fixed').css({
            left: 0,
            top: 0
          });
          curState = 'top';
        }
      }
      function fixed() {
        if (curState !== 'fixed') {
          $root.addClass('fixed').css({
            left: rootLeft + 'px',
            top: 0
          });
          curState = 'fixed';
        }
      }
      function bottom() {
        if (curState !== 'bottom') {
          $root.removeClass('fixed').css({
            left: 0,
            top: rootBottomTop + 'px'
          });
          curState = 'bottom';
        }
      }
      function setState() {
        var scrollTop = $scrollTarget.scrollTop();
        if (scrollTop >= rootTop && scrollTop <= scrollBottom) {
          fixed();
        } else if (scrollTop < rootTop) {
          top();
        } else {
          bottom();
        }
      }
      function init() {
        if(!hasInit) {
          var interval, timeout;
          calc(true); setState();
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState();
          });
          $window.on('resize', function() {
            disabled || (calc(true), setState());
          });
          hasInit = true;
        }
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions,
        refresh: function() {
          calc(true, { animation: false }); setState();
        }
      };
    }
    $.fn.affix = affix;
  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    function toc(options) {
      var $root = this, $window = $(window), $scrollTarget, $scroller, $tocUl = $('<ul class="toc toc--ellipsis"></ul>'), $tocLi, $headings, $activeLast, $activeCur,
        selectors = 'h1,h2,h3', container = 'body', scrollTarget = window, scroller = 'html, body', disabled = false,
        headingsPos, scrolling = false, hasRendered = false, hasInit = false;

      function setOptions(options) {
        var _options = options || {};
        _options.selectors && (selectors = _options.selectors);
        _options.container && (container = _options.container);
        _options.scrollTarget && (scrollTarget = _options.scrollTarget);
        _options.scroller && (scroller = _options.scroller);
        _options.disabled !== undefined && (disabled = _options.disabled);
        $headings = $(container).find(selectors).filter('[id]');
        $scrollTarget = $(scrollTarget);
        $scroller = $(scroller);
      }
      function calc() {
        headingsPos = [];
        $headings.each(function() {
          headingsPos.push(Math.floor($(this).position().top));
        });
      }
      function setState(element, disabled) {
        var scrollTop = $scrollTarget.scrollTop(), i;
        if (disabled || !headingsPos || headingsPos.length < 1) { return; }
        if (element) {
          $activeCur = element;
        } else {
          for (i = 0; i < headingsPos.length; i++) {
            if (scrollTop >= headingsPos[i]) {
              $activeCur = $tocLi.eq(i);
            } else {
              $activeCur || ($activeCur = $tocLi.eq(i));
              break;
            }
          }
        }
        $activeLast && $activeLast.removeClass('active');
        ($activeLast = $activeCur).addClass('active');
      }
      function render() {
        if(!hasRendered) {
          $root.append($tocUl);
          $headings.each(function() {
            var $this = $(this);
            $tocUl.append($('<li></li>').addClass('toc-' + $this.prop('tagName').toLowerCase())
              .append($('<a></a>').text($this.text()).attr('href', '#' + $this.prop('id'))));
          });
          $tocLi = $tocUl.children('li');
          $tocUl.on('click', 'a', function(e) {
            e.preventDefault();
            var $this = $(this);
            scrolling = true;
            setState($this.parent());
            $scroller.scrollToAnchor($this.attr('href'), 400, function() {
              scrolling = false;
            });
          });
        }
        hasRendered = true;
      }
      function init() {
        var interval, timeout;
        if(!hasInit) {
          render(); calc(); setState(null, scrolling);
          // run calc every 100 millisecond
          interval = setInterval(function() {
            calc();
          }, 100);
          timeout = setTimeout(function() {
            clearInterval(interval);
          }, 45000);
          window.pageLoad.then(function() {
            setTimeout(function() {
              clearInterval(interval);
              clearTimeout(timeout);
            }, 3000);
          });
          $scrollTarget.on('scroll', function() {
            disabled || setState(null, scrolling);
          });
          $window.on('resize', window.throttle(function() {
            if (!disabled) {
              render(); calc(); setState(null, scrolling);
            }
          }, 100));
        }
        hasInit = true;
      }

      setOptions(options);
      if (!disabled) {
        init();
      }
      $window.on('resize', window.throttle(function() {
        init();
      }, 200));
      return {
        setOptions: setOptions
      };
    }
    $.fn.toc = toc;
  });
})();
/*(function () {

})();*/
</script><script>
  /* toc must before affix, since affix need to konw toc' height. */(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  var TOC_SELECTOR = window.TEXT_VARIABLES.site.toc.selectors;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window);
    var $articleContent = $('.js-article-content');
    var $tocRoot = $('.js-toc-root'), $col2 = $('.js-col-aside');
    var toc;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');
    var hasToc = $articleContent.find(TOC_SELECTOR).length > 0;

    function disabled() {
      return $col2.css('display') === 'none' || !hasToc;
    }

    tocDisabled = disabled();

    toc = $tocRoot.toc({
      selectors: TOC_SELECTOR,
      container: $articleContent,
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      tocDisabled = disabled();
      toc && toc.setOptions({
        disabled: tocDisabled
      });
    }, 100));

  });
})();
(function() {
  var SOURCES = window.TEXT_VARIABLES.sources;
  window.Lazyload.js(SOURCES.jquery, function() {
    var $window = $(window), $pageFooter = $('.js-page-footer');
    var $pageAside = $('.js-page-aside');
    var affix;
    var tocDisabled = false;
    var hasSidebar = $('.js-page-root').hasClass('layout--page--sidebar');

    affix = $pageAside.affix({
      offsetBottom: $pageFooter.outerHeight(),
      scrollTarget: hasSidebar ? '.js-page-main' : null,
      scroller: hasSidebar ? '.js-page-main' : null,
      scroll: hasSidebar ? $('.js-page-main').children() : null,
      disabled: tocDisabled
    });

    $window.on('resize', window.throttle(function() {
      affix && affix.setOptions({
        disabled: tocDisabled
      });
    }, 100));

    window.pageAsideAffix = affix;
  });
})();
</script><script>
  window.Lazyload.js(['https://cdn.bootcss.com/jquery/3.1.1/jquery.min.js', 'https://cdn.bootcss.com/Chart.js/2.7.2/Chart.bundle.min.js'], function() {
    var $canvas = null, $this = null, _ctx = null, _text = '';
    $('.language-chart').each(function(){
      $this = $(this);
      $canvas = $('<canvas></canvas>');
      _text = $this.text();
      $this.text('').append($canvas);
      _ctx = $canvas.get(0).getContext('2d');
      (_ctx && _text) && (new Chart(_ctx, JSON.parse(_text)) && $this.attr('data-processed', true));
    });
  });
</script>
<script type="text/x-mathjax-config">
	var _config = { tex2jax: {
		inlineMath: [['$','$'], ['\\(','\\)']]
	}};MathJax.Hub.Config(_config);
</script>
<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  window.Lazyload.js('https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js', function() {
    mermaid.initialize({
      startOnLoad: true
    });
    mermaid.init(undefined, '.language-mermaid');
  });
</script>

    </div>
    <script>(function () {
  var $root = document.getElementsByClassName('root')[0];
  if (window.hasEvent('touchstart')) {
    $root.dataset.isTouch = true;
    document.addEventListener('touchstart', function(){}, false);
  }
})();
</script>
  </body>
</html>

